<div class="p-fluid">
  <h5>Register resultat</h5>
  <form [formGroup]="occasionForm" (ngSubmit)="onSubmit()">

    <div formArrayName="occasions">

      @for (occasionGroup of occasions.controls; track $index) {
      <p-card [formGroupName]="$index" styleClass="p-mb-4">

        <ng-template pTemplate="title">
          Träningspass {{ $index + 1 }}
        </ng-template>

        <ng-template pTemplate="icons">
          <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-text"
            (click)="removeOccasion($index)" [disabled]="occasions.length === 1"
            title="Ta bort detta träningspass"></button>
        </ng-template>

        <div class="p-grid p-formgrid p-dir-col">

          <div class="flex p-col-12 p-field">
            <div class="flex-auto dp">
              <label for="date-{{$index}}">Datum/Tid</label>
              <p-datepicker [formControlName]="'date'" id="dp" inputId="date-{{$index}}" [firstDayOfWeek]="1"
                [maxDate]="maxDate" [showOtherMonths]="false" placeholder="Välj datum och tid" dateFormat="yy/mm/dd"
                appendTo="body"></p-datepicker>
              @if(occasionGroup.get('date')?.invalid && occasionGroup.get('date')?.touched){
              <small class="p-error">
                Datum krävs.
              </small>
              }
            </div>
          </div>

          <div class="flex p-col-12 p-field">
            <div class="flex-auto">
              <label for="note-{{$index}}">Anteckning</label>
              <input pInputText id="note-{{$index}}" [formControlName]="'note'" placeholder="Valfritt" />
            </div>
          </div>

          <hr class="p-mt-3 p-mb-3">

          <div formArrayName="sets">

            <h5 class="p-mb-2">Sets som genomförts</h5>

            @for (setGroup of getSets(occasionGroup).controls; track $index; let j = $index) {

              
            <div class="grid grid-cols-12 gap-4" >
              <div class="col-span-6">
                <div class="column-content-style">
                  <div class="p-text-bold mb-2" style="font-size: 1.3em; font-weight: 300;">Set {{ j + 1 }}:</div>
                </div>
              </div>
              <div class="col-span-6">
                <div class="column-content-style flex">
                  <div class="p-col-fixed flex" style="width: 40px; margin-left: auto;">
                    <p-button icon="pi pi-times" variant="text" severity="danger"
                    class="p-button-rounded p-button-danger p-button-text" (click)="removeSet(occasionGroup, j)"
                    [disabled]="getSets(occasionGroup).length === 1" title="Ta bort detta set"></p-button>
                  </div>
                </div>
              </div>
            </div>
            
            
            
            <div [formGroupName]="j">
              <div class="grid grid-cols-12 gap-4">
                <div class="col-span-6">
                  <div class="column-content-style">
                    <h5>Reps</h5>

                    <div class="p-col p-field">
                      
                      <p-inputNumber [formControlName]="'reps'" inputId="reps-{{$index}}-{{j}}" mode="decimal"
                        [showButtons]="true" [min]="1" placeholder="Antal">
                      </p-inputNumber>
                      @if(setGroup.get('reps')?.invalid && setGroup.get('reps')?.touched){
                      <small class="p-error">
                        Reps krävs (min 1).
                      </small>
                      }
                    </div>

                  </div>
                </div>

                <div class="col-span-6">
                  <div class="column-content-style">
                    <h5>Vikt</h5>


                    <div class="p-col p-field">
                      
                      <p-inputNumber [formControlName]="'weight'" inputId="weight-{{$index}}-{{j}}" mode="decimal"
                        [showButtons]="true" [min]="0" placeholder="kg">
                      </p-inputNumber>

                      @if(setGroup.get('reps')?.invalid && setGroup.get('reps')?.touched){
                      <small class="p-error">
                        Vikt krävs (min 0).
                      </small>
                      }
                    </div>


                  </div>
                </div>
              </div>





            </div>

            }

            <div class="p-col-12 p-mt-2">
              <p-button type="button" icon="pi pi-plus" variant="outlined" severity="success" label="Lägg till Set"
                class="p-button-outlined" (click)="addSet(occasionGroup)"></p-button>
            </div>
          </div>

        </div>
      </p-card>
      }
    </div>

    <div class="p-mt-4">
      <p-badge type="button" icon="pi pi-plus" label="Lägg till träningspass" class="p-button-secondary"
        (click)="addOccasion()"></p-badge>
    </div>

    <div class="p-mt-4">
      <p-button type="submit" label="Spara resultat" [disabled]="occasionForm.invalid"></p-button>
    </div>
  </form>
</div>