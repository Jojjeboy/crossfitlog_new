<div class="p-fluid">
  <form [formGroup]="occasionForm" (ngSubmit)="onSubmit()">

    <div formArrayName="occasions">

      @for (occasionGroup of occasions.controls; track $index) {
      <p-card [formGroupName]="$index" styleClass="p-mb-4">

        <ng-template pTemplate="title">
          Träningspass {{ $index + 1 }}
        </ng-template>

        <ng-template pTemplate="icons">
          <button pButton pRipple icon="pi pi-trash" class="p-button-danger p-button-text"
            (click)="removeOccasion($index)" [disabled]="occasions.length === 1"
            title="Ta bort detta träningspass"></button>
        </ng-template>

        <div class="p-grid p-formgrid p-dir-col">

          <div class="p-col-12 p-field">
            <label for="date-{{$index}}">Datum/Tid</label>
            <p-datepicker [formControlName]="'date'" [showTime]="true" [showSeconds]="false" inputId="date-{{$index}}"
              [showOtherMonths]="true" placeholder="Välj datum och tid" dateFormat="yy/mm/dd"
              appendTo="body"></p-datepicker>
            @if(occasionGroup.get('date')?.invalid && occasionGroup.get('date')?.touched){
                <small class="p-error">
                Datum krävs.
              </small>
            }
          </div>

          <div class="p-col-12 p-field">
            <label for="note-{{$index}}">Anteckning</label>
            <input pInputText id="note-{{$index}}" [formControlName]="'note'" />
          </div>

          <hr class="p-mt-3 p-mb-3">

          <div formArrayName="sets">

            <h4 class="p-mb-2">Sets som genomförts</h4>

            @for (setGroup of getSets(occasionGroup).controls; track $index; let j = $index) {
            <div [formGroupName]="j"
              class="p-grid p-align-center p-mb-2 p-gap-2">

              <span class="p-text-bold p-mr-2">Set {{ j + 1 }}:</span>

              <div class="p-col p-field">
                <label for="reps-{{$index}}-{{j}}" class="p-sr-only">Reps</label>
                <p-inputNumber [formControlName]="'reps'" inputId="reps-{{$index}}-{{j}}" mode="decimal"
                  [showButtons]="true" [min]="1" placeholder="Reps">
                </p-inputNumber>
                @if(setGroup.get('reps')?.invalid && setGroup.get('reps')?.touched){
                  <small class="p-error">
                    Reps krävs (min 1).
                  </small>
                }
              </div>

              <div class="p-col p-field">
                <label for="weight-{{$index}}-{{j}}" class="p-sr-only">Vikt (kg)</label>
                <p-inputNumber [formControlName]="'weight'" inputId="weight-{{$index}}-{{j}}" mode="decimal"
                  [showButtons]="true" [min]="0" placeholder="Vikt (kg)">
                </p-inputNumber>

                @if(setGroup.get('reps')?.invalid && setGroup.get('reps')?.touched){
                  <small class="p-error">
                    Vikt krävs (min 0).
                  </small>
                }
              </div>

              <div class="p-col-fixed" style="width: 40px;">
                <p-button  icon="pi pi-times" class="p-button-rounded p-button-danger p-button-text"
                  (click)="removeSet(occasionGroup, j)" [disabled]="getSets(occasionGroup).length === 1"
                  title="Ta bort detta set"></p-button>
              </div>
            </div>
            }

            <div class="p-col-12 p-mt-2">
              <p-button type="button" icon="pi pi-plus" label="Lägg till Set" class="p-button-outlined"(click)="addSet(occasionGroup)"></p-button>
            </div>
          </div>

        </div>
      </p-card>
      }
    </div>

    <div class="p-mt-4">
      <p-badge type="button" icon="pi pi-plus" label="Lägg till träningspass" class="p-button-secondary"
        (click)="addOccasion()"></p-badge>
    </div>

    <div class="p-mt-4">
      <p-button type="submit" label="Spara alla pass" [disabled]="occasionForm.invalid"></p-button>
    </div>
  </form>
</div>